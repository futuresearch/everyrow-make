{
    "label": "Start Merge Task",
    "description": "Join two tables using AI-powered matching. Returns a task ID for polling.",
    "type": "action",
    "connection": "everyrow-api",
    "parameters": [
        {
            "name": "sessionName",
            "label": "Session Name",
            "type": "text",
            "required": false,
            "default": "Make.com Merge",
            "help": "Label for this session (visible in EveryRow dashboard)"
        },
        {
            "name": "leftTable",
            "label": "Left Table (Primary)",
            "type": "array",
            "required": true,
            "spec": {
                "type": "collection",
                "spec": []
            },
            "help": "Primary array of objects to join"
        },
        {
            "name": "rightTable",
            "label": "Right Table (Secondary)",
            "type": "array",
            "required": true,
            "spec": {
                "type": "collection",
                "spec": []
            },
            "help": "Secondary array of objects to join with the left table"
        },
        {
            "name": "task",
            "label": "Task Description",
            "type": "text",
            "required": true,
            "multiline": true,
            "help": "Describe how rows should be matched. Example: 'Match companies by name, accounting for abbreviations and variations'"
        },
        {
            "name": "mergeOnLeft",
            "label": "Left Key Field",
            "type": "text",
            "required": true,
            "help": "Field name in left table to use for matching"
        },
        {
            "name": "mergeOnRight",
            "label": "Right Key Field",
            "type": "text",
            "required": true,
            "help": "Field name in right table to use for matching"
        },
        {
            "name": "model",
            "label": "LLM Model",
            "type": "select",
            "required": false,
            "default": "",
            "options": [
                { "label": "Auto (Default)", "value": "" },
                { "label": "Claude 3.5 Haiku", "value": "claude-3-5-haiku" },
                { "label": "Claude 3.5 Sonnet", "value": "claude-3-5-sonnet" },
                { "label": "GPT-4o", "value": "gpt-4o" },
                { "label": "GPT-4o Mini", "value": "gpt-4o-mini" }
            ],
            "help": "LLM model to use for matching",
            "advanced": true
        }
    ],
    "communication": [
        {
            "url": "/sessions/create",
            "method": "POST",
            "body": {
                "name": "{{parameters.sessionName}}"
            },
            "response": {
                "temp": {
                    "sessionId": "{{body.id}}"
                }
            }
        },
        {
            "url": "/tasks",
            "method": "POST",
            "body": {
                "task_type": "create_group",
                "session_id": "{{temp.sessionId}}",
                "data": "{{parameters.leftTable}}"
            },
            "response": {
                "temp": {
                    "leftArtifactTaskId": "{{body.id}}"
                }
            }
        },
        {
            "url": "/tasks/{{temp.leftArtifactTaskId}}/status",
            "method": "GET",
            "response": {
                "temp": {
                    "leftArtifactId": "{{body.artifact_id}}"
                }
            }
        },
        {
            "url": "/tasks",
            "method": "POST",
            "body": {
                "task_type": "create_group",
                "session_id": "{{temp.sessionId}}",
                "data": "{{parameters.rightTable}}"
            },
            "response": {
                "temp": {
                    "rightArtifactTaskId": "{{body.id}}"
                }
            }
        },
        {
            "url": "/tasks/{{temp.rightArtifactTaskId}}/status",
            "method": "GET",
            "response": {
                "temp": {
                    "rightArtifactId": "{{body.artifact_id}}"
                }
            }
        },
        {
            "url": "/tasks",
            "method": "POST",
            "body": {
                "task_type": "deep_merge",
                "session_id": "{{temp.sessionId}}",
                "query": {
                    "task": "{{parameters.task}}",
                    "merge_on_left": "{{parameters.mergeOnLeft}}",
                    "merge_on_right": "{{parameters.mergeOnRight}}",
                    "model": "{{parameters.model}}"
                },
                "input_artifacts": ["{{temp.leftArtifactId}}"],
                "context_artifacts": ["{{temp.rightArtifactId}}"]
            },
            "response": {
                "output": {
                    "taskId": "{{body.id}}",
                    "sessionId": "{{temp.sessionId}}",
                    "status": "{{body.status}}"
                }
            }
        }
    ],
    "interface": [
        {
            "name": "taskId",
            "label": "Task ID",
            "type": "text"
        },
        {
            "name": "sessionId",
            "label": "Session ID",
            "type": "text"
        },
        {
            "name": "status",
            "label": "Initial Status",
            "type": "text"
        }
    ],
    "samples": {
        "taskId": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
        "sessionId": "b2c3d4e5-f6a7-8901-bcde-f23456789012",
        "status": "pending"
    }
}
